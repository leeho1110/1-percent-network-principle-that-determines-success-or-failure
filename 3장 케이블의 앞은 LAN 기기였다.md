# 3장: 케이블의 앞은 LAN 기기였다

### 1. 케이블과 리피터, 허브 속을 신호가 흘러간다

- 앞장에서 이더넷 헤더에 필요한 여러 요소들까지 모두 채워넣었습니다. 이번 장에선 LAN 어댑터를 통해 겹겹이 싸여진 패킷이 어떻게 송신되는지 확인합니다.
- LAN 어댑터의 PHY(MAU) 회로에서는 전기 신호로 형태가 변경됩니다. 이 때 변경된 전기 신호는 **RJ-45 커넥터를 통해 트위스트 페어 케이블**에 들어갑니다.
    - 전기 신호는 케이블 내에서 허브에 도착할 때까지 신호가 조금씩 변형되고 약해집니다. 처음엔 직각의 산 모양을 잘 유지하지만, 점점 잡음이 섞이며 파형이 왜곡되고 각이 뭉개지죠.
        - 이는 주파수와 에너지 비율에 따른 전기 신호의 성질과 관련이 있으며 이 때문에 수신 측에선 0,1을 잘못 판독하게 될 가능성이 존재합니다. 이것이 바로 통신 오류의 원인입니다.
    - 일반 단선 케이블이 아닌 트위스트 페어 케이블을 사용하는 이유가 바로 이것입니다. 신호선을 꼬게 되면 앞서 말한 통신 오류의 원인이 되는 잡음을 방지할 수 있습니다.
        - ‘꼼’이 잡음을 막을 수 있는 이유는 잡음의 발생 원리로부터 기원합니다. 이는 생략합니다.
- 리피터 허브에 신호가 도착하면 LAN 전체에 신호가 뿌려지게 됩니다.
    - 리피터 허브는 MAC 주소에 해당하는 기기에게만 패킷을 보내는 스위칭 허브와는 다릅니다.
    - **전체 네트워크에 패킷을 뿌리고 수신처에 해당하는 기기만 패킷을 수신하는 이더넷의 기본 원리**를 실현합니다.
        - 신호는 커넥터 내부의 회로를 통해 해석되는데 이는 생략합니다.
        - 신호를 수신한 기기는 자신이 수신처에 해당하는 경우만 수신하고, 아닌 경우는 무시합니다.

---

### 2. 스위칭 허브의 패킷 중계 동작

- 스위칭 허브는 라우터와 마찬가지로 네비게이션을 봅니다. 이 네비게이션의 이름은 **주소 테이블**입니다.
    - MAC 주소와 포트, 제어 정보가 등록되어있어 패킷을 수신했을 때 적혀있는 주소를 확인해 특정 포트로 패킷을 송신합니다.
    - 아까 리피터 허브와 다른 점은 네비게이션입니다. 리피터 허브는 자신과 연결된 네트워크에 모두 패킷을 송신했지만, 스위칭 허브는 자신이 판독한 포트(기기)에만 포트를 송신합니다.
    - 스위칭 허브는 LAN 어댑터와는 달리 MAC 주소가 할당되어 있지 않습니다.
        - 다만 모든 패킷을 수신해 버퍼 메모리에 저장합니다.
        - 패킷을 저장하는 이유는 주소 테이블과 대조해 다음 수신처 MAC 주소를 알아내기 위함입니다.
        - 패킷을 송신하는 경우 스위치 회로를 경유하게 되는데 이 원리는 생략합니다.
- 스위칭 허브는 패킷 중계 시 MAC 주소표의 내용도 갱신합니다.
    - 내용을 갱신하는 행위를 **갱신 동작**이라고 부르는데, 이는 패킷 수신 시 진행됩니다.
        - 송신처 MAC 주소와 수신한 입력 포트를 매핑해 MAC 주소표에 등록하는 것을 의미합니다.
        - 등록된 정보는 일정 시간(일반적으로 몇 분)이 경과하면 삭제됩니다.
- 전이중, 반이중 모드에 대한 설명은 생략합니다.

---

### 3. 라우터의 패킷 중계 동작

- 라우터는 중계 부분과 포트 부분으로 나눠져 동작합니다.
    - 중계 부분은 패킷의 중계 대상을 판단합니다.
    - 포트 부분이 패킷을 송수신합니다.
- 아까 스위칭 허브가 패킷의 수신자를 어떻게 판단했는지 기억하시나요? 바로 네비게이션입니다. 라우터도 이와 같이 테이블을 활용해 중계 대상을 판단합니다.
    - 다른 점은 스위칭 허브에선 MAC 주소를, 라우터에서는 IP 주소를 활용한다는 점입니다. 물론 기록되는 제어 정보도 다릅니다.
    - 이를 라우터에서는 **라우팅 테이블** 혹은 **경로표**라고 부릅니다.
        - 라우터는 라우팅 테이블에서 넷마스크를 활용해 **네트워크 번호만 조사**합니다.
    - 라우팅 테이블을 갱신하는 행위는 패킷 중계와 독립적입니다.
        - 사람이 수동으로 갱신하거나
        - 라우팅 프로토콜을 통해 라우터끼리 서로 경로 정보를 교환하고 등록합니다.
- 라우터는 IP 주소를 판단하는 것이 목적이기 때문에 **MAC 헤더는 패킷을 수신한 뒤 폐기**합니다.
    - 패킷 중계 동작은 다음 순서로 이루어집니다.
        1. 먼저 경로표에서 중계 대상을 조사합니다.
            - 조사 시 아까 이야기한 라우팅 테이블을 활용합니다.
            - 넷마스크 항목의 네트워크 번호의 비트 수를 판단해 네트워크 번호 부분만 비교합니다.
            - 네트워크 번호만 비교하는 경우 복수의 후보가 발견되는 경우가 존재하는데, 이 경우 **네트워크 번호의 비트 수가 가장 긴 것**을 찾습니다.
                - 그 이유는 네트워크 번호의 비트 수가 호스트 번호의 비트 수가 반비례하기 때문입니다.
                - 이는 중계 대상의 범위가 작다는 것을 의미하기에, 중계 대상을 정확하게 판단할 가능성이 높아집니다.
                - 추가적으로 메트릭 값(작은 것을 우선순위로)도 판단합니다.
        2. 만약 일치하는 중계 대상이 존재하지 않다면 패킷을 폐기하고, ICMP 메시지로 송신처에 통지합니다.
            - 스위칭 허브는 규모가 작기에 ICMP 메시지를 통지해도 네트워크 혼잡 오류를 야기하지 않지만, 라우터는 다릅니다. 따라서 라우터는 패킷을 폐기합니다.
            - 경로가 없는 경우 넷마스크가 `0.0.0.0` 인 기본 경로를 활용할 수 있습니다.
- 패킷은 라우터를 통과하며 **TTL(Time-To-Live) 헤더의 값을 1씩 감소**시킵니다.
    - 이는 패킷이 네트워크 상에서 무한 순환하는 사태를 방지하기 위함입니다.
    - 만약 TTL 헤더의 값이 0이 되면 패킷을 폐기합니다.
- 패킷이 너무 큰 경우 **조각 나누기(fragmentation)**을 통해 패킷을 작게 분할하고 중계합니다.
    - 프라그멘테이션은 패킷이 만들어진 뒤 분할됩니다. TCP에서 스트림 데이터를 MSS에 맞춰 자르는 것과는 다릅니다.
- 패킷을 송신할 땐 **라우팅 테이블의 ‘게이트웨이’ 항목에서 수신 IP 상대를 판단**합니다.
    - IP 주소가 결정되면 ARP를 통해 MAC 주소를 확인합니다.
    - 패킷의 운반은 이더넷이 수행합니다.
        - 라우터에는 스위칭 허브가 내장인 경우도 있고, 아닌 경우도 있습니다.

---